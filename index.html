<!doctype html>
<html lang="so">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laam Wallet - 3 Step Demo</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;padding:18px;background:#f7f7fb;color:#222;}
.container{max-width:720px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(20,20,60,0.06);}
h1,h2{margin-top:0;}
input{display:block;padding:10px;margin:8px 0;width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:6px;}
button{padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer;margin-top:6px;}
.hidden{display:none;}
.status{margin-top:8px;color:#444;font-size:14px;}
code{background:#f3f4f6;padding:4px 6px;border-radius:6px;}
#blocksList{margin-top:12px;border-top:1px dashed #eee;padding-top:10px;}
.block{padding:8px;border-radius:8px;background:#f8fafc;margin-bottom:8px;border:1px solid #eef2ff;}
.txItem{font-size:13px;margin-top:6px;background:#fff;padding:6px;border-radius:6px;border:1px solid #e5e7eb;}
</style>
</head>
<body>
<div class="container">
  <h1>Laam Wallet Demo - 3 Step Flow</h1>

  <!-- Step 1: Signup -->
  <section id="signupSection">
    <h2>Step 1: Signup</h2>
    <input id="nameInput" placeholder="Magacaaga" />
    <input id="contactInput" placeholder="Email ama Phone" />
    <input id="passwordInput" placeholder="Password" type="password" />
    <button id="signupBtn">Codso PIN / OTP</button>
    <div id="signupStatus" class="status"></div>
  </section>

  <!-- Step 2: Enter PIN -->
  <section id="pinSection" class="hidden">
    <h2>Step 2: Geli PIN la diray</h2>
    <input id="pinInput" placeholder="Geli PIN (123456)" />
    <button id="verifyPinBtn">Verify PIN</button>
    <div id="pinStatus" class="status"></div>
  </section>

  <!-- Step 3: Wallet Dashboard -->
  <section id="walletSection" class="hidden">
  <h2>Step 3: Wallet Dashboard</h2>
  <div><b>Address:</b> <code id="meAddr"></code></div>
  <div><b>Balance:</b> <span id="meBal"></span></div>

  <h3>Send Money</h3>
  <input id="toContact" placeholder="Recipient Phone or Email" />
  <input id="amount" placeholder="Amount" type="number" />
  <input id="memo" placeholder="Memo (optional)" />
  <button id="sendBtn">Dir Lacag</button>
  <div id="sendStatus" class="status"></div>

  <h3>Blocks Explorer</h3>
  <button id="createBlockBtn">Abuur Block (Mine)</button>
  <div id="blocksList"></div>
  </section>
</div>

<script>
// ---------------- UTILS ----------------
function uid(len=8){ return Math.random().toString(16).slice(2,2+len) }
function nowTs(){ return new Date().toISOString() }
function generateAddress() { return '0x'+Array.from({length:40},()=>Math.floor(Math.random()*16).toString(16)).join(''); }

// ---------------- STORAGE ----------------
const DB={ get(k){return JSON.parse(localStorage.getItem(k)||'null')}, set(k,v){localStorage.setItem(k,JSON.stringify(v))} };
if(!DB.get('laam_users')) DB.set('laam_users',{});
if(!DB.get('laam_blocks')) DB.set('laam_blocks',[]);
if(!DB.get('laam_txs')) DB.set('laam_txs',[]);

// ---------------- ELEMENTS ----------------
const signupSection=document.getElementById('signupSection');
const pinSection=document.getElementById('pinSection');
const walletSection=document.getElementById('walletSection');

const nameInput=document.getElementById('nameInput');
const contactInput=document.getElementById('contactInput');
const passwordInput=document.getElementById('passwordInput');
const signupBtn=document.getElementById('signupBtn');
const signupStatus=document.getElementById('signupStatus');

const pinInput=document.getElementById('pinInput');
const verifyPinBtn=document.getElementById('verifyPinBtn');
const pinStatus=document.getElementById('pinStatus');

const meAddr=document.getElementById('meAddr');
const meBal=document.getElementById('meBal');
const toAddr=document.getElementById('toAddr');
const amount=document.getElementById('amount');
const memo=document.getElementById('memo');
const sendBtn=document.getElementById('sendBtn');
const sendStatus=document.getElementById('sendStatus');

const blocksList=document.getElementById('blocksList');
const createBlockBtn=document.getElementById('createBlockBtn');

let session=null;
let otpStore={};

// ---------------- STEP 1: Signup ----------------
signupBtn.onclick=()=>{
  const name=nameInput.value.trim();
  const contact=contactInput.value.trim();
  const password=passwordInput.value.trim();
  if(!name||!contact||!password){signupStatus.textContent='Geli dhammaan xogta'; return;}

  // Create user with random address
  const users=DB.get('laam_users');
  if(!users[contact]) users[contact]={ name, password, address:generateAddress(), balance:1000, createdAt: nowTs() };
  DB.set('laam_users', users);

  // "Send OTP" demo
  otpStore[contact]='123456';
  signupStatus.textContent='PIN / OTP waa la diray (demo: 123456)';

  session={contact};
  signupSection.classList.add('hidden');
  pinSection.classList.remove('hidden');
}

// ---------------- STEP 2: Verify PIN ----------------
verifyPinBtn.onclick=()=>{
  const pin=pinInput.value.trim();
  const contact=session?.contact;
  if(!otpStore[contact]){pinStatus.textContent='OTP lama dirin'; return;}
  if(pin!==otpStore[contact]){pinStatus.textContent='PIN / OTP khalad ah'; return;}

  pinStatus.textContent='PIN sax ah. Welcome!';
  pinSection.classList.add('hidden');
  walletSection.classList.remove('hidden');

  const user=DB.get('laam_users')[contact];
  meAddr.textContent=user.address;
  meBal.textContent=user.balance;

  renderBlocks();
}

// ---------------- STEP 3: Wallet ----------------
sendBtn.onclick = () => {
  sendStatus.textContent = '';
  const contact = session?.contact;
  const users = DB.get('laam_users');
  const sender = users[contact];

  const recipientContact = toContact.value.trim(); // sax
  const amt = Number(amount.value);
  if(!recipientContact || !amt || amt <= 0){ sendStatus.textContent='Geli xog sax ah'; return;}
  if(sender.balance < amt){ sendStatus.textContent='Balance ma filna'; return;}

  if(!users[recipientContact]){
      users[recipientContact] = { name:'Unknown', address:generateAddress(), balance:0, createdAt:nowTs() };
  }
  const recipient = users[recipientContact];

  const tx = {
      txHash: '0x'+uid(12),
      fromAddr: sender.address,
      toAddr: recipient.address,
      amount: amt,
      memo: memo.value,
      ts: nowTs()
  };

  const txs = DB.get('laam_txs'); txs.push(tx); DB.set('laam_txs', txs);

  sender.balance -= amt;
  recipient.balance += amt;
  DB.set('laam_users', users);

  createBlock([tx]);
  meBal.textContent = sender.balance;
  sendStatus.textContent = "Transfer OK â†’ " + tx.txHash;

  toContact.value=''; amount.value=''; memo.value='';
}
// ---------------- BLOCKCHAIN ----------------

function renderBlocks(){
  const blocks = DB.get('laam_blocks')||[];
  blocksList.innerHTML='';
  for(const b of blocks.slice().reverse()){
      const d=document.createElement('div'); d.className='block';
      d.innerHTML = `
        <strong>Block #${b.index}</strong><br/>
        Prev: <code>${b.prevHash}</code><br/>
        Hash: <code>${b.hash}</code><br/>
        Txs: ${b.txs.length}<br/>
        Time: ${b.ts}
      `;

      for(const t of b.txs){
          const tx = document.createElement('div'); tx.className='txItem';
          tx.innerHTML = `
            <b>${t.txHash}</b><br>
            <b>From:</b> ${t.fromAddr}<br>
            <b>To:</b> ${t.toAddr}<br>
            <b>Amount:</b> ${t.amount}<br>
            <b>Memo:</b> ${t.memo||"-"}<br>
            <small>${t.ts}</small>
          `;
          d.appendChild(tx);
      }
      blocksList.appendChild(d);
  }
}


// Genesis block
if(!(DB.get('laam_blocks')||[]).length) createBlock([]);
renderBlocks();
</script>
</body>
</html>
