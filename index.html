<!doctype html>
<html lang="so">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laam Demo - Decentralized Phone Wallet (Updated)</title>

<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  padding:18px;background:#f7f7fb;color:#222;
}
.container{
  max-width:720px;margin:0 auto;background:#fff;padding:18px;
  border-radius:10px;box-shadow:0 6px 20px rgba(20,20,60,0.06)
}
h1{margin-top:0;font-size:20px}
input{
  display:block;padding:10px;margin:8px 0;width:100%;box-sizing:border-box;
  border:1px solid #ddd;border-radius:6px
}
button{
  padding:10px 14px;border-radius:8px;border:0;background:#2563eb;
  color:#fff;cursor:pointer;margin-top:6px
}
.hidden{display:none}
.status{margin-top:8px;color:#444;font-size:14px}
code{background:#f3f4f6;padding:4px 6px;border-radius:6px}
#blocksList{margin-top:12px;border-top:1px dashed #eee;padding-top:10px}
.block{
  padding:8px;border-radius:8px;background:#f8fafc;margin-bottom:8px;
  border:1px solid #eef2ff
}
.txItem{
  font-size:13px;margin-top:6px;background:#fff;padding:6px;border-radius:6px;
  border:1px solid #e5e7eb;
}
</style>

</head>
<body>
<div class="container">
  <h1>Laam Demo - Decentralized Phone Wallet</h1>

  <!-- REGISTER -->
  <section id="register">
    <h2>1) Diiwaangelin / Create Account</h2>
    <input id="phoneInput" placeholder="+2519..." />
    <button id="reqOtpBtn">Codso OTP (Demo)</button>

    <div id="otpArea" class="hidden">
      <input id="otpInput" placeholder="Geli OTP (123456)" />
      <button id="verifyOtpBtn">Verify OTP</button>
    </div>

    <div id="regStatus" class="status"></div>
  </section>

  <!-- WALLET -->
  <section id="wallet" class="hidden">
    <h2>Wallet-kaaga</h2>
    <div><b>Phone:</b> <span id="mePhone"></span></div>
    <div><b>Address:</b> <code id="meAddr"></code></div>
    <div><b>Balance:</b> <span id="meBal"></span></div>
  </section>

  <!-- SEND -->
  <section id="send" class="hidden">
    <h2>2) Dir Lacag</h2>
    <input id="toPhone" placeholder="Recipient +2519..." />
    <input id="amount" placeholder="Amount" type="number" />
    <input id="memo" placeholder="Memo (optional)" />
    <button id="sendBtn">Dir Lacag</button>
    <div id="sendStatus" class="status"></div>
  </section>

  <!-- EXPLORER -->
  <section id="explorer">
    <h2>Explorer (Blocks & Transactions)</h2>
    <button id="createBlockBtn">Abuur Block (Mine)</button>
    <div id="blocksList"></div>
  </section>

</div>

<script>
// ---------------- UTILS ----------------
function uid(len=8){ return Math.random().toString(16).slice(2,2+len) }
function nowTs(){ return new Date().toISOString() }

// Generate random 0x address
function generateAddress() {
    return '0x' + Array.from({length:40},()=>Math.floor(Math.random()*16).toString(16)).join('');
}
  
// ---------------- STORAGE ----------------
const DB={
  get(k){ return JSON.parse(localStorage.getItem(k)||'null') },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
};

if(!DB.get('laam_users')) DB.set('laam_users',{});
if(!DB.get('laam_blocks')) DB.set('laam_blocks',[]);
if(!DB.get('laam_txs')) DB.set('laam_txs',[]);

// ---------------- ELEMENTS ----------------
const phoneInput=document.getElementById('phoneInput');
const reqOtpBtn=document.getElementById('reqOtpBtn');
const otpArea=document.getElementById('otpArea');
const otpInput=document.getElementById('otpInput');
const verifyOtpBtn=document.getElementById('verifyOtpBtn');
const regStatus=document.getElementById('regStatus');

const walletSection=document.getElementById('wallet');
const mePhoneSpan=document.getElementById('mePhone');
const meAddrCode=document.getElementById('meAddr');
const meBalSpan=document.getElementById('meBal');

const sendSection=document.getElementById('send');
const toPhone=document.getElementById('toPhone');
const amount=document.getElementById('amount');
const memo=document.getElementById('memo');
const sendBtn=document.getElementById('sendBtn');
const sendStatus=document.getElementById('sendStatus');

const blocksList=document.getElementById('blocksList');
const createBlockBtn=document.getElementById('createBlockBtn');

let otpStore={};
let session=DB.get('laam_session')||null;
if(session) showWallet(session.phone);

// ---------------- OTP REQUEST ----------------
reqOtpBtn.onclick=()=>{
  const phone=phoneInput.value.trim();
  if(!phone){ regStatus.textContent='Geli phone sax ah'; return; }

  otpStore[phone]={otp:"123456",ts:Date.now()};
  regStatus.textContent="OTP waa la diray (demo): 123456";

  otpArea.classList.remove('hidden');
};

// ---------------- VERIFY OTP ----------------
verifyOtpBtn.onclick=()=>{
  const phone=phoneInput.value.trim();
  const code=otpInput.value.trim();

  if(!otpStore[phone]){ regStatus.textContent='OTP lama dirin'; return; }
  if(code!=="123456"){ regStatus.textContent='OTP khalad ah'; return; }

  const users=DB.get('laam_users');
  if(!users[phone]){
    users[phone]={address:mkAddress(phone),createdAt:nowTs(),balance:1000};
    DB.set('laam_users', users);
  }

  session={phone,address:users[phone].address};
  DB.set('laam_session', session);

  regStatus.textContent='OTP OK. Wallet Ready.';
  otpArea.classList.add('hidden');

  showWallet(phone);
};

// ---------------- SHOW WALLET ----------------
function showWallet(phone){
  const u=DB.get('laam_users')[phone];

  walletSection.classList.remove('hidden');
  sendSection.classList.remove('hidden');

  mePhoneSpan.textContent=phone;
  meAddrCode.textContent=u.address;
  meBalSpan.textContent=u.balance;

  renderBlocks();
}

// ---------------- SEND MONEY ----------------
sendBtn.onclick=()=>{
  sendStatus.textContent='';

  const from=session?.phone;
  const to=toPhone.value.trim();
  const amt=Number(amount.value);

  if(!to||!amt||amt<=0){ sendStatus.textContent='Geli xog sax ah'; return; }

  const users=DB.get('laam_users');
  if(!users[to]) users[to]={address:mkAddress(to),createdAt:nowTs(),balance:0};

  const sender=users[from];
  if(sender.balance<amt){ sendStatus.textContent='Balance ma filna'; return; }

  const tx={
    txHash:'0x'+uid(12),
    fromAddr:sender.address,
    toAddr:users[to].address,
    amount:amt,
    memo:memo.value,
    ts:nowTs()
  };

  const txs=DB.get('laam_txs'); 
  txs.push(tx); 
  DB.set('laam_txs', txs);

  sender.balance-=amt;
  users[to].balance+=amt;
  DB.set('laam_users', users);

  createBlock([tx]);

  meBalSpan.textContent=sender.balance;
  sendStatus.textContent="Transfer OK â†’ "+tx.txHash;

  toPhone.value=''; amount.value=''; memo.value='';
};

// ---------------- BLOCKCHAIN ----------------
createBlockBtn.onclick=()=>createBlock([]);

function createBlock(txs=[]){
  const blocks=DB.get('laam_blocks');
  const prev=blocks.length?blocks[blocks.length-1].hash:'0x0';

  const block={
    index:blocks.length,
    ts:nowTs(),
    prevHash:prev,
    hash:'0x'+uid(20),
    txs
  };

  blocks.push(block);
  DB.set('laam_blocks', blocks);
  renderBlocks();
}

// ---------------- DISPLAY BLOCKS ----------------
function renderBlocks(){
  const blocks=DB.get('laam_blocks');
  blocksList.innerHTML='';

  for(const b of blocks.slice().reverse()){
    const d=document.createElement('div');
    d.className='block';
    d.innerHTML=`
      <strong>Block #${b.index}</strong><br/>
      Prev: <code>${b.prevHash}</code><br/>
      Hash: <code>${b.hash}</code><br/>
      Txs: ${b.txs.length}<br/>
      Time: ${b.ts}
    `;

    for(const t of b.txs){
      const tx=document.createElement('div');
      tx.className='txItem';
      tx.innerHTML = `
        <b>${t.txHash}</b><br/>
        <b>From:</b> ${t.fromAddr}<br/>
        <b>To:</b> ${t.toAddr}<br/>
        <b>Amount:</b> ${t.amount}<br/>
        <b>Memo:</b> ${t.memo || "-"}<br/>
        <small>${t.ts}</small>
      `;
      d.appendChild(tx);
    }
    blocksList.appendChild(d);
  }
}

// Genesis block if empty
if(!DB.get('laam_blocks').length) createBlock([]);
renderBlocks();
</script>
</body>
</html>
